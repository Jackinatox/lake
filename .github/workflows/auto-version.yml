name: Auto Increment Version

on:
    push:
        branches:
            - master
            - main

jobs:
    bump-version:
        # Skip if this commit was already a version bump to avoid infinite loops
        if: "!contains(github.event.head_commit.message, '[skip ci]')"
        runs-on: self-hosted
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  # Fetch full history so we can push back
                  fetch-depth: 0

            - name: Bump patch version in package.json
              id: bump
              run: |
                  current=$(jq -r .version package.json)
                  IFS='.' read -ra parts <<< "$current"
                  new_patch=$(( ${parts[2]} + 1 ))
                  new_version="${parts[0]}.${parts[1]}.${new_patch}"
                  jq --arg v "$new_version" '.version = $v' package.json > package.json.tmp
                  mv package.json.tmp package.json
                  echo "new_version=$new_version" >> $GITHUB_OUTPUT
                  echo "old_version=$current" >> $GITHUB_OUTPUT

            - name: Commit and push version bump
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json
                  git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }} [skip ci]"
                  git push
